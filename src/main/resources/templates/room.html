<!DOCTYPE html>
<html lang="en">

<head>

    <head>
        <meta charset="utf-8">
        <title>Room Manage</title>
        <!-- Stylesheets -->
        <link th:href="@{/css/bootstrap.min.copy.css}" rel="stylesheet">
        <link rel="stylesheet" type="text/css" th:href="@{/css/slick-theme.css}">
        <link rel="stylesheet" type="text/css" th:href="@{/css/slick.css}">
        <link th:href="@{/css/mmenu.css}" rel="stylesheet">
        <link th:href="@{/css/style.copy.css}" rel="stylesheet">
        <link th:href="@{/css/modal.css}" rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="https://themify.me/themify-icons" rel="stylesheet">
        <link rel="shortcut icon" th:href="@{/images/favicon.png}" type="image/x-icon">
        <link rel="icon" th:href="@{/images/favicon.png}" type="image/x-icon">
        <!-- Responsive -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script><![endif]-->
        <!--[if lt IE 9]><script src="js/respond.js"></script><![endif]-->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
</head>

<body>


    <div class="boxcar-wrapper">
        <header class="boxcar-header header-style-v1 style-two inner-header cus-style-1">
            <div th:if="${user1.role == 'ROLE_ADMIN'}">
                <div th:replace="~{fragments/header_admin :: header}"></div>
            </div>

            <div th:if="${user1.role == 'ROLE_RECEPTIONIST'}">
                <div th:replace="~{fragments/header_recep :: header}"></div>
            </div>
        </header>
        <!-- cars-section-fourteen -->
        <section class="cars-section-fourteen layout-radius">
            <div class="shop-c-box">
                <div class="boxcar-container">
                    <div class="boxcar-title-three">
                        <ul class="breadcrumb">
                            <li><a href="#">Home</a></li>
                            <li><span>Room</span></li>
                        </ul>
                        <h2>Room List</h2>
                    </div>
                    <div class="row">
                        <div class="col-lg-3 col-md-12 col-sm-12">
                            <div class="side-bar">
                                <div class="categories-box">
                                    <label for="date">Ngày:</label>
                                    <input type="date" id="checkin-date" name="checkin-date"
                                        style="display: inline-block; margin-left: 10px;" required>
                                </div>
                                <!-- <div class="categories-box">
                                    <label for="time">Giờ:</label>
                                    <input type="time" id="time">
                                </div> -->
                                <!-- <div class="categories-box">
                            <h6 class="title">Stattus</h6>
                            <div class="cheak-box">
                                <label class="contain">Phong trong
                                    <input type="checkbox" checked="checked">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="contain">Phong da dat
                                    <input type="checkbox">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="contain">Phong dang thue
                                    <input type="checkbox">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="contain">Tat ca phong
                                    <input type="checkbox">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        </div> -->
                                <form>
                                    <div class="categories-box">
                                        <h6 class="title">Status</h6>
                                        <div class="cheak-box">
                                            <label class="contain">
                                                <h6>Rented Room</h6>
                                                <input type="radio" class="selectCheckbox" name="statusFilter"
                                                    value="Rented Room">
                                                <span class="checkmark"></span>
                                            </label>
                                            <label class="contain">
                                                <h6>Booked Room</h6>
                                                <input type="radio" class="selectCheckbox" name="statusFilter"
                                                    value="Booked Room">
                                                <span class="checkmark"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="categories-box">
                                        <h6 class="title">Room Type</h6>
                                        <div class="cheak-box" th:each="roomType : ${roomTypes}">
                                            <label class="contain">
                                                <h6 th:text="${roomType.roomTypeName}"></h6>
                                                <input type="radio" class="selectCheckbox2" name="selectedRoomTypeName"
                                                    th:value="${roomType.roomTypeName}">
                                                <span class="checkmark"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="button-container">
                                        <button class="reset-button" onclick="resetRadios()">All Rooms</button>
                                    </div>


                                    <style>
                                        .button-container {
                                            text-align: center;
                                            margin-top: 20px;
                                        }
                                        .reset-button {
                                            background-color: #4CAF50; /* Green */
                                            border: none;
                                            color: white;
                                            padding: 15px 32px;
                                            text-align: center;
                                            text-decoration: none;
                                            display: inline-block;
                                            font-size: 16px;
                                            margin: 4px 2px;
                                            cursor: pointer;
                                            border-radius: 8px;
                                            transition: background-color 0.3s;
                                        }
                                        .reset-button:hover {
                                            background-color: #45a049;
                                        }
                                    </style>
                                
                                    <script>
                                        function resetRadios() {
                                            let radios = document.querySelectorAll('input[type="radio"]');
                                            radios.forEach(radio => {
                                                radio.checked = false;
                                            });
                                        }
                                    </script>
                                </form>


                            </div>
                        </div>
                        <div class="content-column col-lg-9 col-md-12 col-sm-12">
                            <div class="inner-column">
                                <div class="text-box">
                                    <div class="title">Results</div>
                                </div>
                                <div class="row" id="available-rooms">

                                </div>
                                <div class="pagination">
                                    <button id="prev-page" onclick="changePage(-1)">Previous</button>
                                    <span id="page-info"></span>
                                    <button id="next-page" onclick="changePage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </section>
    </div>
    <div th:replace="~{fragments/footer :: footer}"></div>

    <style>
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 0 5px;
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover {
            background-color: #0056b3;
        }

        #page-info {
            margin: 0 10px;
        }
    </style>

    <!-- modal chứa cả các giao diện phủ lên -->
    <div class="modal js-modal">
        <div class="window js-modal-window">
            <div class="title" id="idPhong"></div>
            <div class="main">
                <div class="header">
                    <div>
                        <span class="material-icons">account_box</span>
                        <span id="txblTenKH" class="text"></span>
                    </div>
                    <div>
                        <span class="material-icons">calendar_today</span>
                        <span id="txblNgayDen" class="text"></span>
                    </div>
                    <div>
                        <span class="material-icons" id="icDayorHour">calendar_today</span>
                        <span id="txblSoNgay" class="text"></span>
                    </div>
                    <div>
                        <span class="material-icons">group</span>
                        <span id="txblSoNguoi" class="text"></span>
                    </div>
                </div>
                <p id="invoiceId" style="display: none;"></p>
                <p id="bookingMappingId" style="display: none;"></p>
                <p id="bookingMappingActive" style="display: none;"></p>
                <div class="lefttt">
                    <div class="list-view">

                        <table border="1">
                            <thead>
                                <tr>
                                    <th>Dịch vụ</th>
                                    <th>SL</th>
                                    <th>Thành tiền</th>
                                    <th style="display: none;"></th>
                                </tr>
                            </thead>
                            <tbody id="lvSuDungDV">
                                <!-- <tr>
                                    <td>1</td>
                                    <td>alo</td>
                                    <td>123</td>
                                </tr> -->
                            </tbody>
                        </table>

                    </div>
                    <button class="button green-button js-themDV" id="btnThemDV">Thêm dịch vụ</button>
                </div>
                <div class="righttt">
                    <div class="list view">
                        <p>Cập nhật tình trạng phòng</p>
                        <input type="text" name="t1" id="statusPhong" value="" readonly>
                        <br>
                        <p>Cập nhật tình trạng dọn dẹp</p>
                        <select id="cleaningRoom">
                            <option>Cleaned</option>
                            <option>Not Clean</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button class="button green-button" id="btnThanhToan">Thanh toán</button>
                <!-- <button class="button green-button" id="btnNhanPhong">Nhận phòng</button> -->
                <button class="button green-button" id="btnLuu">Lưu</button>
                <button class="button gray-button js-modal-close" id="btnThoat">Thoát</button>
            </div>
        </div>
    </div>

    <div class="modal js-modal-2">
        <div class="window js-modal-window-2">
            <div class="title">Thêm Dịch Vụ</div>
            <div class="main main--service">
                <div class="leftttDV">
                    <p>Danh sách dịch vụ</p>
                    <select id="cbTimKiemLoaiDV" class="combobox" onchange="sendServiceTypeId(this.value)">
                        <option value="0">Tất cả dịch vụ</option>
                        <option th:each="serviceType : ${serviceTypes}" th:text="${serviceType.SeTypeName}"
                            th:value="${serviceType.SeTypeID}">
                        </option>
                    </select>
                    <!-- <form class="searchDV" action="/search" method="get">
                    <input type="text" name="query" placeholder="Tìm dịch vụ" />
                    <button type="submit">Tìm</button>
                </form> -->
                    <div class="InputContainerSearch">
                        <input placeholder="Search.." id="input" class="inputSearch" name="seName" type="text">
                    </div>
                    <div class="list-view-DV">

                        <table border="1">
                            <thead>
                                <tr>
                                    <th>Loại DV</th>
                                    <th>Dịch Vụ</th>
                                    <th>Giá</th>
                                    <th>Thêm</th>
                                </tr>
                            </thead>
                            <!-- <tbody id="lvDanhSachDV">
                            <tr id="serviceDS">
                                <td id="serviceTypeName"></td>
                                <td id="serviceName"></td>
                                <td id="servicePrice"></td>
                                <td id="addService"></td>
                            </tr>
                        </tbody> -->
                            <tbody id="lvDanhSachDV">
                                <tr id="serviceDS" th:each="service : ${services}">
                                    <td id="serviceId" style="display: none;" th:text="${service.seId}"></td>
                                    <td id="serviceTypeName" th:text="${service.seTypeName}"></td>
                                    <td id="serviceName" th:text="${service.seName}"></td>
                                    <td id="servicePrice" th:text="${service.sePrice}"></td>
                                    <td id="addService"><a href="javascript:void(0)" class="wait-link">
                                            <span class="material-icons" style="color: green;">add_circle</span>
                                        </a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="rightttDV">
                    <p>Dịch vụ đã chọn</p>
                    <div class="list-view-DVDaChon">

                        <table border="1">
                            <thead>
                                <tr>
                                    <th>Dịch Vụ</th>
                                    <th>Số Lượng</th>
                                    <th>Thành Tiền</th>
                                    <th>Xóa</th>
                                </tr>
                            </thead>
                            <tbody id="lvDichVuDaChon">
                                <!-- <tr>
                                <td>1</td>
                                <td>alo</td>
                                <td>123</td>
                                <td><a href="listinvoice" class="wait-link">
                                    <span class="material-icons" style="color: red;">cancel</span>
                                </a></td>
                            </tr> -->
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
            <div class="footer">
                <button class="button green-button" id="btnLuuDV">Lưu</button>
                <button class="button gray-button js-modal-close-2" id="btnThoat">Thoát</button>
            </div>

            <!-- == -->
        </div>
    </div>
    <!-- hiệu ứng js trượt vào  -->
    <script>
        const buyBtns = document.querySelectorAll('.js-buy-ticket')
        // 3 nút có class js.. lưu vào biến buyBtns
        const modal = document.querySelector('.js-modal')
        // lấy tất cả các thằng có class .js-modal
        const modalClose = document.querySelector('.js-modal-close')

        const modalWindow = document.querySelector('.js-modal-window')

        // Lấy các nút cần tương tác
        const btnNhanPhong = document.getElementById('btnNhanPhong');
        const btnThanhToan = document.getElementById('btnThanhToan');
        const btnThemDV = document.getElementById('btnThemDV')


        // hàm hiện modal mua vé (thêm class open cả modal)
        function showByTickets() {
            modal.classList.add('open')
            // alert('ok')
        }

        // hàm ẩn modal mua vé (xóa class open ở modal)
        function hideByTickets() {
            modal.classList.remove('open')

        }
        // lặp qua từng thẻ button và nghe hành vi click
        for (const buyBtn of buyBtns) {
            // từng thằng trong buyBtns
            buyBtn.addEventListener('click', showByTickets)
        }
        // nghe hành vi click vaof button close
        modalClose.addEventListener('click', hideByTickets)
        // khi click vào tất cả các khoảng modal 
        modal.addEventListener('click', hideByTickets)
        // vì khi click vào tất cả các khoảng modal thì nó
        // bao gồm các giao diện phủ lên nên ngăn chặn bằng stopPropagation
        modalWindow.addEventListener('click', function (event) {
            event.stopPropagation()
        })

        let currentRoomId; // Biến toàn cục để lưu roomId

        function openModal(roomId, bookingMappingId, bookingMappingActive) {
            // Hiển thị modal
            modal.classList.add('open');

            // Lưu roomId vào biến toàn cục
            currentRoomId = roomId;
            console.log("customer:", bookingMappingId);

            if (bookingMappingActive === 1) {
                const statusPhong = document.getElementById('statusPhong');
                if (statusPhong) statusPhong.value = "Booked Room";

                const txblTenKH = document.getElementById('txblTenKH');
                const txblNgayDen = document.getElementById('txblNgayDen');
                const txblSoNgay = document.getElementById('txblSoNgay');
                const txblSoNguoi = document.getElementById('txblSoNguoi');
                if (txblTenKH) txblTenKH.textContent = "Chưa nhận phòng";
                if (txblNgayDen) txblNgayDen.textContent = "Chưa nhận phòng";
                if (txblSoNgay) txblSoNgay.textContent = "Chưa nhận phòng";
                if (txblSoNguoi) txblSoNguoi.textContent = "Chưa nhận phòng";

                const btnThanhToan = document.getElementById('btnThanhToan');
                const btnThemDV = document.getElementById('btnThemDV');
                if (btnThanhToan) btnThanhToan.style.display = 'none';
                if (btnThemDV) btnThemDV.style.display = 'none';
            } else {
                const statusPhong = document.getElementById('statusPhong');
                if (statusPhong) statusPhong.value = "Rented Room";

                const btnThanhToan = document.getElementById('btnThanhToan');
                const btnThemDV = document.getElementById('btnThemDV');
                if (btnThanhToan) btnThanhToan.style.display = 'inline-block';
                if (btnThemDV) btnThemDV.style.display = 'inline-block';
            }


            // Gửi request đến controller để lấy thông tin phòng
            fetch(`/receptionist/editRoom?bookingMappingId=${bookingMappingId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("customer:", data);

                    document.getElementById('txblTenKH').textContent = data.invoice[0].customerName;
                    // console.log("customer:",data.bookingID.customerID.customerName);
                    document.getElementById('txblNgayDen').textContent = data.bookingMapping[0].checkInDate;
                    document.getElementById('txblSoNgay').textContent = data.bookingMapping[0].checkOutDate;
                    document.getElementById('txblSoNguoi').textContent = data.customerQuantity;
                    //document.getElementById('invoiceId').textContent = invoiceId;
                    document.getElementById('bookingMappingId').textContent = bookingMappingId;
                    document.getElementById('bookingMappingActive').textContent = bookingMappingActive;

                    fetch(`/receptionist/findInvoiceId?bookingMappingId=${bookingMappingId}`)
                        .then(response => response.json())
                        .then(data => {
                            // Cập nhật thông tin phòng vào modal
                            // Ví dụ:
                            //Cập nhật các thông tin khác tương tự
                            document.getElementById('invoiceId').textContent = data.invoiceId;
                            console.log("invoiceId:", data.invoiceId);


                        })
                        .catch(error => {
                            console.error('Lỗi khi lấy thông tin invoice:', error);
                        }
                        );


                    if (bookingMappingActive == 1) {
                        document.getElementById('statusPhong').value = "Booked Room";
                        document.getElementById('txblTenKH').textContent = "Chưa nhận phòng";
                        document.getElementById('txblNgayDen').textContent = "Chưa nhận phòng";
                        document.getElementById('txblSoNgay').textContent = "Chưa nhận phòng";
                        document.getElementById('txblSoNguoi').textContent = "Chưa nhận phòng";
                    } else {
                        document.getElementById('statusPhong').value = "Rented Room";
                    }

                })
                .catch(error => {
                    console.log("customer:", data);
                    console.error('Lỗi khi lấy thông tin khách hàng:', error);

                }
            );

            fetch(`/receptionist/editRoom2?roomId=${roomId}`)
                .then(response => response.json())
                .then(data => {
                    // Cập nhật thông tin phòng vào modal
                    // Ví dụ:
                    document.getElementById('idPhong').textContent = data.roomNum;


                })
                .catch(error => {
                    console.error('Lỗi khi lấy thông tin phòng:', error);
                }
            );


            var invoiceLineData;
            // Lấy tham chiếu đến nút "Lưu"
            const saveButton = document.getElementById('btnLuu');
            saveButton.addEventListener('click', () => {
                const tbodyElement = document.getElementById('lvSuDungDV');
                invoiceLineData = [];

                for (let i = 0; i < tbodyElement.rows.length; i++) {
                    const row = tbodyElement.rows[i];
                    const quantity = row.cells[1].textContent;
                    const amount = row.cells[2].textContent;
                    const seId = row.cells[3].textContent;
                    const invoiceId = document.getElementById('invoiceId').textContent;

                    invoiceLineData.push({
                        InvoiceTotalAmount: amount,
                        SeID: seId,
                        Quantity: quantity,
                        InvoiceID: invoiceId
                    });
                }

                console.log("invoiceLineData", JSON.stringify(invoiceLineData)); // Thêm log để kiểm tra dữ liệu


                // Gọi hàm sendSelectedServices() để gửi dữ liệu đến controller
                sendSelectedServices();
                updateRoomCleaning();
            }
            );

            function sendSelectedServices() {
                fetch('/receptionist/addInvoiceLine', {
                    method: 'POST', // Ensure method is POST
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceLineData)
                })
                    .then(response => {
                        if (response.ok) {
                            console.log("Invoice lines saved successfully");
                            window.location.href = `/receptionist/room`;
                            // Redirect or handle success as needed
                        } else {
                            console.error('Failed to save selected services');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }

            function updateRoomCleaning() {
                // Lấy trạng thái dọn dẹp được chọn từ dropdown
                const cleaningStatus = document.querySelector('#cleaningRoom').value;

                // Sử dụng biến toàn cục currentRoomId
                const roomId = currentRoomId;

                // Chuẩn bị dữ liệu để gửi lên server
                const roomData = {
                    id: roomId,
                    cleaning: cleaningStatus
                };
                console.log("RoomData:", JSON.stringify(roomData));

                // Gửi dữ liệu lên server bằng AJAX
                fetch(`/receptionist/updateRoomCleaning/${roomId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(roomData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        console.log('Cập nhật trạng thái dọn dẹp phòng thành công:', data);
                    })
                    .catch(error => {
                        console.error('Lỗi khi cập nhật trạng thái dọn dẹp phòng:', error);
                    });
            }



            // Lấy nút "Thanh toán"
            const btnThanhToan = document.getElementById('btnThanhToan');

            // Thêm sự kiện click cho nút "Thanh toán"
            btnThanhToan.addEventListener('click', async () => {
                try {
                    // Hiển thị confirm dialog
                    const confirmed = await confirmPayment();
                    if (confirmed) {
                        // Lấy giá trị của phần tử <p id="invoiceId">
                        const invoiceId = document.getElementById('invoiceId').textContent;

                        // Gửi HTTP request lên server để cập nhật trạng thái phòng
                        const roomId = await updateRoomStatus2();

                        const bookingMappingID = await updateBookingMapping();

                        // Gửi HTTP request lên server
                        const response = await fetch(`/receptionist/invoicePayment/${invoiceId}`, {
                            method: 'GET'
                        });

                        // Kiểm tra nếu request thành công
                        if (response.ok) {
                            // Chuyển hướng sang trang invoice1
                            window.location.href = `/receptionist/invoicePayment/${invoiceId}`;
                        } else {
                            console.error('Có lỗi xảy ra khi gửi invoiceID lên server');
                        }
                    } else {
                        console.log('Thanh toán đã bị hủy');
                    }
                } catch (error) {
                    console.error('Lỗi khi gửi HTTP request:', error);
                }
            });

            async function confirmPayment() {
                return new Promise((resolve) => {
                    const confirmed = window.confirm('Bạn có muốn thanh toán không?');
                    resolve(confirmed);
                });
            }

            async function updateRoomStatus2() {
                try {
                    // Lấy giá trị của phần tử <p id="roomId">
                    //const roomId = document.getElementById('idPhong').textContent;

                    // Gửi HTTP request lên server để cập nhật trạng thái phòng
                    const response = await fetch(`/receptionist/updateStatusRoom2?roomId=${roomId}`, {
                        method: 'GET'
                    });

                    if (response.ok) {
                        // Lấy dữ liệu từ response
                        const room = await response.json();
                        console.log('Room updated:', room);
                        return room.id;
                    } else {
                        console.error('Có lỗi xảy ra khi cập nhật trạng thái phòng');
                        return null;
                    }
                } catch (error) {
                    console.error('Lỗi khi gửi HTTP request:', error);
                    return null;
                }
            }

            async function updateBookingMapping() {
                try {
                    // Lấy giá trị của phần tử <p id="roomId">
                    const bookingMappingId = document.getElementById('bookingMappingId').textContent;

                    // Gửi HTTP request lên server để cập nhật trạng thái phòng
                    const response = await fetch(`/receptionist/updateBookingMapping?bookingMappingId=${bookingMappingId}`, {
                        method: 'GET'
                    });

                    if (response.ok) {
                        // Lấy dữ liệu từ response
                        const bookingMapping = await response.json();
                        console.log('BookingMapping updated:', bookingMapping);
                        return bookingMapping.bookingMappingID;
                    } else {
                        console.error('Có lỗi xảy ra khi cập nhật active');
                        return null;
                    }
                } catch (error) {
                    console.error('Lỗi khi gửi HTTP request:', error);
                    return null;
                }
            }






        }


    </script>
    <script>
        const themDVs = document.querySelectorAll('.js-themDV')
        // 3 nút có class js.. lưu vào biến buyBtns
        const modal2 = document.querySelector('.js-modal-2')
        // lấy tất cả các thằng có class .js-modal
        const modalClose2 = document.querySelector('.js-modal-close-2')

        const modalWindow2 = document.querySelector('.js-modal-window-2')

        // hàm hiện modal mua vé (thêm class open cả modal)
        function showByTickets2() {
            modal2.classList.add('open')
            // alert('ok')
        }

        // hàm ẩn modal mua vé (xóa class open ở modal)
        function hideByTickets2() {
            modal2.classList.remove('open')

        }
        // lặp qua từng thẻ button và nghe hành vi click
        for (const themDV of themDVs) {
            // từng thằng trong buyBtns
            themDV.addEventListener('click', showByTickets2)





        }
        // nghe hành vi click vaof button close
        modalClose2.addEventListener('click', hideByTickets2)
        // khi click vào tất cả các khoảng modal 
        modal2.addEventListener('click', hideByTickets2)
        // vì khi click vào tất cả các khoảng modal thì nó
        // bao gồm các giao diện phủ lên nên ngăn chặn bằng stopPropagation
        modalWindow2.addEventListener('click', function (event) {
            event.stopPropagation()
        })

        function sendServiceTypeId(serviceTypeId) {
            if (!serviceTypeId) {
                return; // Không làm gì nếu không có giá trị được chọn
            }

            // Hiển thị modal
            // Gửi request đến controller để lấy thông tin dịch vụ
            fetch(`/receptionist/getServiceBySeTypeId?serviceTypeId=${serviceTypeId}`)
                .then(response => response.json())
                .then(data => {
                    // Lấy reference tới tbody của bảng
                    const tbodyElement = document.getElementById('lvDanhSachDV');

                    // Xóa các dòng hiện có trong tbody
                    while (tbodyElement.firstChild) {
                        tbodyElement.removeChild(tbodyElement.firstChild);
                    }

                    // Lặp qua từng ServiceDetailDTO trong data     
                    data.forEach(serviceDetail => {
                        // Tạo và cấu hình các element cho dòng mới
                        const newRow = document.createElement('tr');
                        newRow.id = 'serviceDS';

                        const serviceIdCell = document.createElement('td');
                        serviceIdCell.id = 'serviceId';
                        serviceIdCell.textContent = serviceDetail.seId;
                        serviceIdCell.style.display = 'none';


                        const serviceTypeNameCell = document.createElement('td');
                        serviceTypeNameCell.id = 'serviceTypeName';
                        serviceTypeNameCell.textContent = serviceDetail.seTypeName;

                        const serviceNameCell = document.createElement('td');
                        serviceNameCell.id = 'serviceName';
                        serviceNameCell.textContent = serviceDetail.seName;

                        const servicePriceCell = document.createElement('td');
                        servicePriceCell.id = 'servicePrice';
                        servicePriceCell.textContent = serviceDetail.sePrice;

                        const addServiceCell = document.createElement('td');
                        addServiceCell.id = 'addService';
                        const addServiceLink = document.createElement('a');
                        addServiceLink.href = 'javascript:void(0)';
                        addServiceLink.classList.add('wait-link');
                        const addServiceIcon = document.createElement('span');
                        addServiceIcon.classList.add('material-icons');
                        addServiceIcon.style.color = 'green';
                        addServiceIcon.textContent = 'add_circle';
                        addServiceLink.appendChild(addServiceIcon);
                        addServiceCell.appendChild(addServiceLink);

                        // Thêm các cell vào dòng mới
                        newRow.appendChild(serviceIdCell);
                        newRow.appendChild(serviceTypeNameCell);
                        newRow.appendChild(serviceNameCell);
                        newRow.appendChild(servicePriceCell);
                        newRow.appendChild(addServiceCell);

                        // Thêm dòng mới vào tbody
                        tbodyElement.appendChild(newRow);
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi lấy danh sách dịch vụ:', error);
                }
                );
        }



        // Lấy tham chiếu đến ô input
        const inputElement = document.getElementById('input');

        // Lắng nghe sự kiện "keyup" trên ô input
        inputElement.addEventListener('keyup', function (event) {
            // Kiểm tra xem người dùng có nhấn phím Enter hay không
            if (event.key === 'Enter') {
                // Lấy giá trị của ô input
                const seName = inputElement.value;
                // Gọi hàm sendServiceName với giá trị seName
                sendServiceName(seName);
            }
        });


        function sendServiceName(seName) {

            // Hiển thị modal
            // Gửi request đến controller để lấy thông tin dịch vụ
            fetch(`/receptionist/getServiceBySeName?seName=${seName}`)
                .then(response => response.json())
                .then(data => {
                    // Lấy reference tới tbody của bảng
                    const tbodyElement = document.getElementById('lvDanhSachDV');

                    // Xóa các dòng hiện có trong tbody
                    while (tbodyElement.firstChild) {
                        tbodyElement.removeChild(tbodyElement.firstChild);
                    }

                    // Lặp qua từng ServiceDetailDTO trong data     
                    data.forEach(serviceDetail => {
                        // Tạo và cấu hình các element cho dòng mới
                        const newRow = document.createElement('tr');
                        newRow.id = 'serviceDS';

                        const serviceIdCell = document.createElement('td');
                        serviceIdCell.id = 'serviceId';
                        serviceIdCell.textContent = serviceDetail.seId;
                        serviceIdCell.style.display = 'none';

                        const serviceTypeNameCell = document.createElement('td');
                        serviceTypeNameCell.id = 'serviceTypeName';
                        serviceTypeNameCell.textContent = serviceDetail.seTypeName;

                        const serviceNameCell = document.createElement('td');
                        serviceNameCell.id = 'serviceName';
                        serviceNameCell.textContent = serviceDetail.seName;

                        const servicePriceCell = document.createElement('td');
                        servicePriceCell.id = 'servicePrice';
                        servicePriceCell.textContent = serviceDetail.sePrice;

                        const addServiceCell = document.createElement('td');
                        addServiceCell.id = 'addService';
                        const addServiceLink = document.createElement('a');
                        addServiceLink.href = 'javascript:void(0)';
                        addServiceLink.classList.add('wait-link');
                        const addServiceIcon = document.createElement('span');
                        addServiceIcon.classList.add('material-icons');
                        addServiceIcon.style.color = 'green';
                        addServiceIcon.textContent = 'add_circle';
                        addServiceLink.appendChild(addServiceIcon);
                        addServiceCell.appendChild(addServiceLink);

                        // Thêm các cell vào dòng mới
                        newRow.appendChild(serviceIdCell);
                        newRow.appendChild(serviceTypeNameCell);
                        newRow.appendChild(serviceNameCell);
                        newRow.appendChild(servicePriceCell);
                        newRow.appendChild(addServiceCell);

                        // Thêm dòng mới vào tbody
                        tbodyElement.appendChild(newRow);
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi lấy danh sách dịch vụ:', error);
                }
                );
        }



        // Sử dụng event delegation
        const lvDanhSachDV = document.getElementById('lvDanhSachDV');
        lvDanhSachDV.addEventListener('click', (event) => {
            if (event.target.closest('.wait-link')) {
                addServiceToSelectedTable(event);
            }
        });

        function addServiceToSelectedTable(event) {
            const row = event.target.closest('tr');
            const serviceId = row.querySelector('#serviceId, .serviceId').textContent;
            const serviceName = row.querySelector('#serviceName, .serviceName').textContent;
            const servicePrice = parseFloat(row.querySelector('#servicePrice, .servicePrice').textContent);

            // Kiểm tra xem dịch vụ đã tồn tại trong bảng "Dịch vụ đã chọn"
            const existingRows = document.querySelectorAll('#lvDichVuDaChon tr');
            let existingRow = null;
            for (let i = 0; i < existingRows.length; i++) {
                if (existingRows[i].querySelector('td:first-child').textContent === serviceName) {
                    existingRow = existingRows[i];
                    break;
                }
            }

            // if (existingRow) {
            //     // Nếu dịch vụ đã tồn tại, cập nhật số lượng và thành tiền
            //     const qtyCell = existingRow.querySelector('td:nth-child(2)');
            //     const priceCell = existingRow.querySelector('td:nth-child(3)');
            //     let qty = parseInt(qtyCell.textContent);
            //     qty++;
            //     qtyCell.textContent = qty.toString();
            //     priceCell.textContent = (qty * servicePrice).toFixed(2);
            // } else {
            //     // Nếu dịch vụ chưa tồn tại, thêm hàng mới vào bảng "Dịch vụ đã chọn"
            //     const newRow = document.createElement('tr');
            //     newRow.innerHTML = `
            // <td class="serviceName">${serviceName}</td>
            // <td>1</td>
            // <td class="servicePrice">${servicePrice.toFixed(2)}</td>
            // <td><a href="javascript:void(0)" class="wait-link-1">
            //     <span class="material-icons" style="color: red;">cancel</span>
            // </a></td>
            // <td class="serviceId" style="display:none;">${serviceId}</td>
            // `;
            //     document.getElementById('lvDichVuDaChon').appendChild(newRow);
            //     console.log("row", newRow)
            // }

            if (existingRow) {
                // Nếu dịch vụ đã tồn tại, cập nhật số lượng và thành tiền
                const qtyInput = existingRow.querySelector('input.quantity-input');
                const priceCell = existingRow.querySelector('.servicePrice');
                let qty = parseInt(qtyInput.value);
                qty++;
                qtyInput.value = qty.toString();
                priceCell.textContent = (qty * servicePrice).toFixed(2);
            } else {
                // Nếu dịch vụ chưa tồn tại, thêm hàng mới vào bảng "Dịch vụ đã chọn"
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td class="serviceName">${serviceName}</td>
                    <td class="servicePriceQuantity">
                        <input type="number" class="quantity-input" value="1" min="1" style="width: 50px;">
                    </td>
                    <td class="servicePrice">${servicePrice.toFixed(2)}</td>
                    <td><a href="javascript:void(0)" class="wait-link-1">
                        <span class="material-icons" style="color: red;">cancel</span>
                    </a></td>
                    <td class="serviceId" style="display:none;">${serviceId}</td>
                `;
                document.getElementById('lvDichVuDaChon').appendChild(newRow);

                // Add event listener for quantity input change
                const qtyInput = newRow.querySelector('input.quantity-input');
                qtyInput.addEventListener('change', function () {
                    const priceCell = newRow.querySelector('.servicePrice');
                    let qty = parseInt(qtyInput.value);
                    if (qty < 1) {
                        qty = 1;
                        qtyInput.value = qty;
                    }
                    priceCell.textContent = (qty * servicePrice).toFixed(2);
                });

                console.log("row", newRow);
            }


        }


        const lvDichVuDaChon = document.getElementById('lvDichVuDaChon');
        lvDichVuDaChon.addEventListener('click', (event) => {
            if (event.target.closest('.wait-link-1')) {
                removeServiceFromSelectedTable(event);
            }
        });

        function removeServiceFromSelectedTable(event) {
            const row = event.target.closest('tr');
            row.remove();
        }









        // Gắn sự kiện click vào nút "Lưu"
        var btnLuuDV = document.getElementById('btnLuuDV');
        btnLuuDV.addEventListener('click', function () {
            // Lấy dữ liệu từ bảng "Dịch vụ đã chọn"
            var selectedServices = [];
            var lvDichVuDaChon = document.getElementById('lvDichVuDaChon');
            var rows = lvDichVuDaChon.getElementsByTagName('tr');
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].getElementsByTagName('td');
                var serviceName = cells[0].textContent;
                var quantity = cells[1].querySelector('input.quantity-input').value;
                var price = cells[2].textContent;
                var serviceId = cells[4].textContent;
                selectedServices.push({
                    seName: serviceName,
                    seQuantity: quantity,
                    sePrice: price,
                    seId: serviceId
                });
            }

            // Xóa dữ liệu trong bảng "Sử dụng dịch vụ"
            var lvSuDungDV = document.getElementById('lvSuDungDV');
            lvSuDungDV.innerHTML = '';

            // Thêm dữ liệu đã chọn vào bảng "Sử dụng dịch vụ"
            for (var j = 0; j < selectedServices.length; j++) {
                var newRow = document.createElement('tr');
                var nameTd = document.createElement('td');
                nameTd.textContent = selectedServices[j].seName;
                var quantityTd = document.createElement('td');
                quantityTd.textContent = selectedServices[j].seQuantity;
                var priceTd = document.createElement('td');
                priceTd.textContent = selectedServices[j].sePrice;
                var serviceIdTd = document.createElement('td');
                serviceIdTd.style.display = 'none';
                serviceIdTd.textContent = selectedServices[j].seId;
                newRow.appendChild(nameTd);
                newRow.appendChild(quantityTd);
                newRow.appendChild(priceTd);
                newRow.appendChild(serviceIdTd);
                lvSuDungDV.appendChild(newRow);
            }

            // Đóng modal
            document.querySelector('.js-modal-close-2').click();
        });


    </script>


    <script>
        // Lấy các phần tử HTML cần tương tác
        const statusFilterRadios = document.querySelectorAll('.selectCheckbox[name="statusFilter"]');
        const roomTypeRadios = document.querySelectorAll('input[name="selectedRoomTypeName"]');
        const roomBlocks = document.querySelectorAll('.car-block-fourteen');

        // Lắng nghe sự thay đổi của radio buttons
        statusFilterRadios.forEach(radio => {
            radio.addEventListener('change', filterRooms);
        });

        roomTypeRadios.forEach(radio => {
            radio.addEventListener('change', filterRooms);
        });

        // Hàm lọc các phòng dựa trên trạng thái và loại phòng được chọn
        function filterRooms() {
            const selectedStatusFilter = document.querySelector('.selectCheckbox[name="statusFilter"]:checked');
            const selectedRoomTypeNames = Array.from(document.querySelectorAll('input[name="selectedRoomTypeName"]:checked')).map(radio => radio.value);

            roomBlocks.forEach(block => {
                // Lấy giá trị của room.status
                const statusElement = block.querySelector('#statusRoom');
                const roomStatus = statusElement ? statusElement.textContent.trim() : '';

                // Lấy giá trị của room.roomTypeName
                const typeNameElement = block.querySelector('#typeNameRoom');
                const roomTypeName = typeNameElement ? typeNameElement.textContent.trim() : '';

                let shouldShow = true;

                if (selectedStatusFilter && roomStatus !== selectedStatusFilter.value) {
                    shouldShow = false;
                }

                if (selectedRoomTypeNames.length > 0 && !selectedRoomTypeNames.includes(roomTypeName)) {
                    shouldShow = false;
                }

                block.style.display = shouldShow ? 'block' : 'none';

                console.log('Selected status filter:', selectedStatusFilter ? selectedStatusFilter.value : 'None');
                console.log('Selected room types:', selectedRoomTypeNames);
                console.log('Room status:', roomStatus);
                console.log('Room type name:', roomTypeName);
            });
        }
    </script>


    <!-- <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Lấy ngày hiện tại theo múi giờ Việt Nam
            const now = new Date();
            const vietnamTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" }));
            const year = vietnamTime.getFullYear();
            const month = String(vietnamTime.getMonth() + 1).padStart(2, '0'); // Tháng bắt đầu từ 0
            const day = String(vietnamTime.getDate()).padStart(2, '0');
            const today = `${year}-${month}-${day}`;

            // Thiết lập giá trị nhỏ nhất cho trường checkin date là ngày hiện tại
            const checkinDateInput = document.getElementById("checkin-date");
            checkinDateInput.setAttribute("min", today);

            checkinDateInput.addEventListener("change", function () {
                // Thiết lập giá trị nhỏ nhất cho trường checkout date là giá trị của checkin date
                const checkoutDateInput = document.getElementById("checkout-date");
                checkoutDateInput.setAttribute("min", checkinDateInput.value);
            });
        });
    </script> -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Lấy ngày hiện tại theo múi giờ Việt Nam
            const now = new Date();
            const vietnamTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" }));
            const year = vietnamTime.getFullYear();
            const month = String(vietnamTime.getMonth() + 1).padStart(2, '0'); // Tháng bắt đầu từ 0
            const day = String(vietnamTime.getDate()).padStart(2, '0');
            const today = `${year}-${month}-${day}`;

            // Thiết lập giá trị mặc định và giá trị nhỏ nhất cho trường checkin date là ngày hiện tại
            const checkinDateInput = document.getElementById("checkin-date");
            checkinDateInput.value = today;
            checkinDateInput.setAttribute("min", today);

            checkinDateInput.addEventListener("change", function () {
                // Thiết lập giá trị nhỏ nhất cho trường checkout date là giá trị của checkin date
                const checkoutDateInput = document.getElementById("checkout-date");
                checkoutDateInput.setAttribute("min", checkinDateInput.value);
            });
        });
    </script>



    <!-- js -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const checkinDateElement = document.getElementById('checkin-date');

            if (checkinDateElement) {
                checkinDateElement.addEventListener('change', updateAvailableRooms);
            } else {
                console.error('Element with ID "checkin-date" not found');
            }

            const statusFilterElements = document.querySelectorAll('input[name="statusFilter"]');
            const roomTypeFilterElements = document.querySelectorAll('input[name="selectedRoomTypeName"]');

            statusFilterElements.forEach(element => {
                element.addEventListener('change', updateAvailableRooms);
            });

            roomTypeFilterElements.forEach(element => {
                element.addEventListener('change', updateAvailableRooms);
            });

            // Pagination variables
            window.currentPage = 1;
            window.roomsPerPage = 6;
            window.filteredRooms = [];

            // Fetch all rooms on initial load
            updateAvailableRooms();
        });

        function updateAvailableRooms() {
            const checkinDate = document.getElementById('checkin-date') ? document.getElementById('checkin-date').value : null;

            let url = '/receptionist/roomtest';
            if (checkinDate) {
                url += `?checkinDate=${checkinDate}`;
            }

            fetch(url, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    const availableRoomsTable = document.getElementById('available-rooms');
                    if (availableRoomsTable) {
                        availableRoomsTable.innerHTML = '';

                        window.filteredRooms = data.map(room => {
                            const roomClass = room.bookingMappingActive === 0 ? 'room-available' : (room.bookingMappingActive === 1 ? 'room-booked' : 'room-occupied');
                            const statusText = room.bookingMappingActive === 1 ? 'Booked Room' : (room.bookingMappingActive === 2 ? 'Rented Room' : '');

                            const roomDiv = document.createElement('div');
                            roomDiv.className = `car-block-fourteen col-lg-4 col-md-6 col-sm-6`;
                            roomDiv.innerHTML = `
                            <div class="inner-box ${roomClass}">
                                <div class="content-box">
                                    <h5 class="title">${room.roomNum} <span class="material-icons" style = "margin-left: 80px; font-size: 27px;">cleaning_services</span> <span style = "margin-left: 5px; font-size: 17px;">${room.cleaning}</span></h5>
                                    <ul class="rating">
                                        <li><i class="fa fa-star"></i></li>
                                        <li><i class="fa fa-star"></i></li>
                                        <li><i class="fa fa-star"></i></li>
                                        <li><i class="fa fa-star"></i></li>
                                        <li><i class="fa fa-star"></i></li>
                                    </ul>
                                    <p>
                                        <h10 id="statusRoom" class="checkedRoom">${statusText}</h10>
                                    </p>
                                    <p>
                                        <h10 id="typeNameRoom">${room.roomTypeName}</h10>                               
                                    </p>
                                    <div>
                                        <button class="btn js-buy-ticket" onclick="openModal(${room.id}, ${room.bookingMappingId}, ${room.bookingMappingActive})">
                                            Sửa Thông Tin
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                            return roomDiv;
                        });

                        // Reapply filters after updating the rooms
                        filterRooms();
                    } else {
                        console.error('Element with ID "available-rooms" not found');
                    }
                })
                .catch(error => console.error('Error fetching available rooms:', error));
        }

        function filterRooms() {
            const statusFilter = document.querySelector('input[name="statusFilter"]:checked');
            const roomTypeFilter = document.querySelector('input[name="selectedRoomTypeName"]:checked');

            const statusFilterValue = statusFilter ? statusFilter.value : null;
            const roomTypeFilterValue = roomTypeFilter ? roomTypeFilter.value : null;

            const rooms = window.filteredRooms.filter(room => {
                const statusText = room.querySelector('#statusRoom').textContent;
                const roomTypeName = room.querySelector('#typeNameRoom').textContent;

                const statusMatch = statusFilterValue ? statusText === statusFilterValue : true;
                const roomTypeMatch = roomTypeFilterValue ? roomTypeName === roomTypeFilterValue : true;

                return statusMatch && roomTypeMatch;
            });

            renderRooms(rooms);
        }

        function renderRooms(rooms) {
            const availableRoomsTable = document.getElementById('available-rooms');
            availableRoomsTable.innerHTML = '';

            const start = (window.currentPage - 1) * window.roomsPerPage;
            const end = start + window.roomsPerPage;
            const paginatedRooms = rooms.slice(start, end);

            paginatedRooms.forEach(room => {
                availableRoomsTable.appendChild(room);
            });

            document.getElementById('page-info').textContent = `Page ${window.currentPage} of ${Math.ceil(rooms.length / window.roomsPerPage)}`;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(window.filteredRooms.length / window.roomsPerPage);

            window.currentPage += direction;
            if (window.currentPage < 1) {
                window.currentPage = 1;
            } else if (window.currentPage > totalPages) {
                window.currentPage = totalPages;
            }

            filterRooms();
        }
    </script>





    <div class="scroll-to-top scroll-to-target" data-target="html"><span class="fa fa-angle-up"></span></div>
    <!-- <script th:src="@{/js/test.js}"></> -->
    <script th:src="@{/js/jquery.js}"></script>
    <script th:src="@{/js/popper.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.copy1.js}"></script>
    <script th:src="@{/js/slick.min.js}"></script>
    <script th:src="@{/js/slick-animation.min.js}"></script>
    <script th:src="@{/js/jquery.fancybox.js}"></script>
    <script th:src="@{/js/wow.js}"></script>
    <script th:src="@{/js/appear.js}"></script>
    <script th:src="@{/js/mixitup.js}"></script>
    <script th:src="@{/js/knob.js}"></script>
    <script th:src="@{/js/mmenu.js}"></script>
    <script th:src="@{/js/main.copy1.js}"></script>
</body>

</html>